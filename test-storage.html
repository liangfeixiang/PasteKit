<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­˜å‚¨å·¥å…·ç±»æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            padding: 10px 15px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-success { background-color: #28a745; color: white; }
        .btn-danger { background-color: #dc3545; color: white; }
        .result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            display: none;
        }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .info { background-color: #d1ecf1; color: #0c5460; }
        pre {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ å­˜å‚¨å·¥å…·ç±»æµ‹è¯•</h1>
        
        <div class="test-section">
            <h2>ğŸ“Š ç¯å¢ƒä¿¡æ¯</h2>
            <div id="environmentInfo"></div>
        </div>

        <div class="test-section">
            <h2>ğŸ§ª åŸºç¡€åŠŸèƒ½æµ‹è¯•</h2>
            <button class="btn-primary" onclick="testBasicFunctions()">æµ‹è¯•åŸºç¡€åŠŸèƒ½</button>
            <button class="btn-success" onclick="testBatchOperations()">æµ‹è¯•æ‰¹é‡æ“ä½œ</button>
            <button class="btn-danger" onclick="clearAllData()">æ¸…ç©ºæ‰€æœ‰æ•°æ®</button>
            <div id="basicResult" class="result"></div>
        </div>

        <div class="test-section">
            <h2>ğŸ” ç§˜é’¥å­˜å‚¨æµ‹è¯•</h2>
            <textarea id="keyData" rows="6" style="width: 100%; font-family: monospace;" placeholder="è¾“å…¥ç§˜é’¥æ•°æ®...">{
  "publicKey": "-----BEGIN PUBLIC KEY-----\n...",
  "privateKey": "-----BEGIN PRIVATE KEY-----\n...",
  "aesKey": "my-secret-key",
  "timestamp": 1234567890
}</textarea>
            <br><br>
            <button class="btn-primary" onclick="saveKeyData()">ä¿å­˜ç§˜é’¥</button>
            <button class="btn-success" onclick="loadKeyData()">åŠ è½½ç§˜é’¥</button>
            <div id="keyResult" class="result"></div>
            <pre id="keyOutput" style="display: none;"></pre>
        </div>

        <div class="test-section">
            <h2>ğŸ“‹ æµ‹è¯•ç»“æœ</h2>
            <pre id="testLog"></pre>
        </div>
    </div>

    <script type="module">
        import { StorageUtils } from './src/pastemagic/utils/storageutils.js';

        // æ˜¾ç¤ºç¯å¢ƒä¿¡æ¯
        document.getElementById('environmentInfo').innerHTML = `
            <p><strong>Chromeæ‰©å±•ç¯å¢ƒ:</strong> ${StorageUtils.isChromeExtension() ? 'âœ… æ˜¯' : 'âŒ å¦'}</p>
            <p><strong>localStorageæ”¯æŒ:</strong> ${StorageUtils.supportsLocalStorage() ? 'âœ… æ˜¯' : 'âŒ å¦'}</p>
        `;

        // æ—¥å¿—è®°å½•å‡½æ•°
        function log(message, type = 'info') {
            const logElement = document.getElementById('testLog');
            const timestamp = new Date().toLocaleTimeString();
            logElement.textContent += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(`[${type.toUpperCase()}]`, message);
        }

        // æ˜¾ç¤ºç»“æœå‡½æ•°
        function showResult(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `result ${type}`;
            element.style.display = 'block';
        }

        // æµ‹è¯•åŸºç¡€åŠŸèƒ½
        window.testBasicFunctions = async function() {
            try {
                log('å¼€å§‹åŸºç¡€åŠŸèƒ½æµ‹è¯•...');
                
                // æµ‹è¯•setItemå’ŒgetItem
                const testData = { message: 'Hello Storage!', timestamp: Date.now() };
                await StorageUtils.setItem('test_basic', testData);
                log('âœ… setItem æˆåŠŸ');
                
                const result = await StorageUtils.getItem('test_basic');
                log(`âœ… getItem æˆåŠŸ: ${JSON.stringify(result.test_basic)}`);
                
                // æµ‹è¯•removeItem
                await StorageUtils.removeItem('test_basic');
                const afterRemove = await StorageUtils.getItem('test_basic');
                log(`âœ… removeItem æˆåŠŸ: ${afterRemove.test_basic === null ? 'æ•°æ®å·²åˆ é™¤' : 'åˆ é™¤å¤±è´¥'}`);
                
                showResult('basicResult', 'âœ… åŸºç¡€åŠŸèƒ½æµ‹è¯•é€šè¿‡ï¼', 'success');
                log('ğŸ‰ åŸºç¡€åŠŸèƒ½æµ‹è¯•å®Œæˆ');
                
            } catch (error) {
                log(`âŒ åŸºç¡€åŠŸèƒ½æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                showResult('basicResult', `âŒ æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        };

        // æµ‹è¯•æ‰¹é‡æ“ä½œ
        window.testBatchOperations = async function() {
            try {
                log('å¼€å§‹æ‰¹é‡æ“ä½œæµ‹è¯•...');
                
                // æµ‹è¯•æ‰¹é‡è®¾ç½®
                const batchData = {
                    'batch_test_1': { value: 'data1', type: 'string' },
                    'batch_test_2': { value: 123, type: 'number' },
                    'batch_test_3': { value: true, type: 'boolean' }
                };
                
                await StorageUtils.setItems(batchData);
                log('âœ… æ‰¹é‡è®¾ç½®æˆåŠŸ');
                
                // æµ‹è¯•æ‰¹é‡è·å–
                const keys = ['batch_test_1', 'batch_test_2', 'batch_test_3'];
                const batchResult = await StorageUtils.getItem(keys);
                log(`âœ… æ‰¹é‡è·å–æˆåŠŸ: ${Object.keys(batchResult).length} ä¸ªé¡¹ç›®`);
                
                // æ˜¾ç¤ºç»“æœ
                Object.entries(batchResult).forEach(([key, value]) => {
                    log(`  ${key}: ${JSON.stringify(value)}`);
                });
                
                showResult('basicResult', 'âœ… æ‰¹é‡æ“ä½œæµ‹è¯•é€šè¿‡ï¼', 'success');
                log('ğŸ‰ æ‰¹é‡æ“ä½œæµ‹è¯•å®Œæˆ');
                
            } catch (error) {
                log(`âŒ æ‰¹é‡æ“ä½œæµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                showResult('basicResult', `âŒ æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        };

        // ä¿å­˜ç§˜é’¥æ•°æ®
        window.saveKeyData = async function() {
            try {
                const keyData = JSON.parse(document.getElementById('keyData').value);
                await StorageUtils.setItem('encryptionKeys', keyData);
                log('âœ… ç§˜é’¥æ•°æ®ä¿å­˜æˆåŠŸ');
                showResult('keyResult', 'âœ… ç§˜é’¥ä¿å­˜æˆåŠŸï¼', 'success');
            } catch (error) {
                log(`âŒ ç§˜é’¥ä¿å­˜å¤±è´¥: ${error.message}`, 'error');
                showResult('keyResult', `âŒ ä¿å­˜å¤±è´¥: ${error.message}`, 'error');
            }
        };

        // åŠ è½½ç§˜é’¥æ•°æ®
        window.loadKeyData = async function() {
            try {
                const result = await StorageUtils.getItem('encryptionKeys');
                const keyData = result.encryptionKeys;
                
                if (keyData) {
                    document.getElementById('keyData').value = JSON.stringify(keyData, null, 2);
                    document.getElementById('keyOutput').textContent = JSON.stringify(keyData, null, 2);
                    document.getElementById('keyOutput').style.display = 'block';
                    log('âœ… ç§˜é’¥æ•°æ®åŠ è½½æˆåŠŸ');
                    showResult('keyResult', 'âœ… ç§˜é’¥åŠ è½½æˆåŠŸï¼', 'success');
                } else {
                    log('âš ï¸ æœªæ‰¾åˆ°ä¿å­˜çš„ç§˜é’¥æ•°æ®');
                    showResult('keyResult', 'ğŸ“‹ æš‚æ— ä¿å­˜çš„ç§˜é’¥æ•°æ®', 'info');
                }
            } catch (error) {
                log(`âŒ ç§˜é’¥åŠ è½½å¤±è´¥: ${error.message}`, 'error');
                showResult('keyResult', `âŒ åŠ è½½å¤±è´¥: ${error.message}`, 'error');
            }
        };

        // æ¸…ç©ºæ‰€æœ‰æ•°æ®
        window.clearAllData = async function() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æµ‹è¯•æ•°æ®å—ï¼Ÿ')) {
                try {
                    // æ¸…é™¤æµ‹è¯•ç›¸å…³çš„é”®
                    const testKeys = ['test_basic', 'batch_test_1', 'batch_test_2', 'batch_test_3', 'encryptionKeys'];
                    await StorageUtils.removeItem(testKeys);
                    log('âœ… æµ‹è¯•æ•°æ®å·²æ¸…ç©º');
                    showResult('basicResult', 'ğŸ—‘ï¸ æ•°æ®å·²æ¸…ç©º', 'info');
                    
                    // æ¸…ç©ºè¾“å‡ºåŒºåŸŸ
                    document.getElementById('keyData').value = '';
                    document.getElementById('keyOutput').style.display = 'none';
                } catch (error) {
                    log(`âŒ æ¸…ç©ºæ•°æ®å¤±è´¥: ${error.message}`, 'error');
                    showResult('basicResult', `âŒ æ¸…ç©ºå¤±è´¥: ${error.message}`, 'error');
                }
            }
        };

        log('å­˜å‚¨å·¥å…·ç±»æµ‹è¯•é¡µé¢å·²åŠ è½½');
        log(`ç¯å¢ƒ: ${StorageUtils.isChromeExtension() ? 'Chromeæ‰©å±•' : 'æ™®é€šç½‘é¡µ'}`);
    </script>
</body>
</html>